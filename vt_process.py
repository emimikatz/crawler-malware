import urllib.request
import gridfs
import os
import hashlib
import ssdeep
import pefile
import json
import requests
import mimetypes
from init_database import *
from init_connection import *
from virustotal_python import Virustotal

def get_virustotal(db, fpath, fname, md5):
    file_from_db_to_hd(db, fpath, fname)
    url_report = 'https://www.virustotal.com/vtapi/v2/file/report'
    params_report = {'apikey': '628efd0ccafa70545a87bff6b23330a9642e8c58bef203520a57051c298d4518', 'resource': md5}
    response_report = requests.get(url_report, params=params_report)
    response_json = response_report.json() 
    
    if not response_json['verbose_msg'] == "Scan finished, information embedded":
        url_scan = 'https://www.virustotal.com/vtapi/v2/file/scan'
        params_scan = {'apikey':'628efd0ccafa70545a87bff6b23330a9642e8c58bef203520a57051c298d4518'}
        files_scan = {'file': (fname, open(fname, 'rb'))}
        response_scan = requests.post(url_scan, files=files_scan, params=params_scan)
        response_json = response_scan.json()
    else:
        total = response_json['total']
        positives = response_json['positives']
    scan_id = response_json['scan_id']
    sha1 = response_json['sha1']
    resource = response_json['resource']
    response_code = response_json['response_code']
    #scan_date = response_json['scan_date']
    permalink = response_json['permalink']
    sha256 = response_json['sha256']
    md5 = response_json['md5']
    os.remove(fpath + fname)
    return response_json


def main():
    db = connect_database()
    request = init_connection_urlhaus()
    parse_csv_urlhaus(db, request)
    url = 'http://42.238.142.109:56713/Mozi.m'
    file_from_url_to_db(db, url , get_name_file_from_url(url))
    md5_virus = get_md5(db, dir_path + '/malwares/' , 'vbc.exe')
    json_virustotal = get_virustotal(db, dir_path + '/malwares/', 'vbc.exe', md5_virus)
    
    with open("test.json", "w") as outfile:
        json.dump(json_virustotal, outfile)
        outfile.close()

    fs = gridfs.GridFSBucket(db)
    for i in fs.find():
        print(i.filename)
        
if __name__ == "__main__":
    main()
