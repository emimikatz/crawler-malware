import urllib.request
import gridfs
import os
import hashlib
import ssdeep
import pefile
import json
import requests
import mimetypes
from init_database import *
from init_connection import *
from virustotal_python import Virustotal

def get_virustotal(md5):
    url_report = 'https://www.virustotal.com/vtapi/v2/file/report'
    params_report = {'apikey': '628efd0ccafa70545a87bff6b23330a9642e8c58bef203520a57051c298d4518', 'resource': md5}
    response_report = requests.get(url_report, params=params_report)
    if response_report.status_code == 200:
        response_json = response_report.json()
    elif response_report.status_code == 204:
        return;
    
    if not response_json['verbose_msg'] == "Scan finished, information embedded":
        url_scan = 'https://www.virustotal.com/vtapi/v2/file/scan'
        params_scan = {'apikey':'628efd0ccafa70545a87bff6b23330a9642e8c58bef203520a57051c298d4518'}
        #TODO
        return None
    else:
        total = response_json['total']
        positives = response_json['positives']
        scan_id = response_json['scan_id']
        sha1 = response_json['sha1']
        resource = response_json['resource']
        response_code = response_json['response_code']
        scan_date = response_json['scan_date']
        permalink = response_json['permalink']
        sha256 = response_json['sha256']
        md5 = response_json['md5']
        return response_json

def save_vt_report(vt_report): 
    print(str(vt_report))

    with open("test.json", "w") as outfile:
        print("REPORT SAVED")
        json.dump(vt_report, outfile)
        outfile.close()

        
if __name__ == "__main__":
    main()
