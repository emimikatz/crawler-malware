#!/usr/bin/env python

from pymongo import MongoClient
from collections import OrderedDict
import sys

def init_mongo():
    client = MongoClient('mongodb+srv://admin:crawlermalware@cluster0-uzcfx.mongodb.net/test?retryWrites=true&w=majority')
    db = client.crawler_malware
    create_collections(db)

def connect_database():
    client = MongoClient('mongodb+srv://admin:crawlermalware@cluster0-uzcfx.mongodb.net/test?retryWrites=true&w=majority')
    db = client.crawler_malware
    return db

def create_collections(db):
    create_malware_collection(db)
    create_vt_collection(db)
    create_label_collection(db)
    create_ip_collection(db)

    
def create_malware_collection(db):

    db.malware_collection.drop()
    db.create_collection( "malware_collection")

    vexpr = {
        "$jsonSchema": {
            "bsonType": "object",
	    "uniqueItems": True,
            "required": [ "id_malware" ],
            "properties": {
                "_id": {
                "bsonType": "objectId",
                },
                "id_malware": {
                "bsonType": "string",
                },
                "source_malware": {
                "bsonType": "string",
                },
                "date_added_malware": {
                "bsonType": "date",
                },
                "url_malware": {
                "bsonType": "string",
                },
                "url_status_malware": {
                "bsonType": "bool",
                },
                "threat_malware": {
                "bsonType": "string",
                },
                "tags_malware": {
                "bsonType": "string",
                },
                "url_haus_malware": {
                "bsonType": "string",
                },
                "reporter_malware": {
                "bsonType": "string",
                },
                "md5_malware": {
                "bsonType": "string",
                },
                "sha256_malware": {
                "bsonType": "string",
                },
                "sha1_malware": {
                "bsonType": "string",
                },
                "ssdeep_malware": {
                "bsonType": "string",
                },
                "is_exe_malware": {
                "bsonType": "bool",
                },
                "imphash_malware": {
                "bsonType": "string",
                },
                "rapport_vt_malware": {
                "bsonType": "objectId",
                },
                "ip_malware": {
                "bsonType": "objectId",
                }
	    }                
        }    
    }

    cmd = OrderedDict([('collMod', 'malware_collection'),
        ('validator', vexpr),
        ('validationLevel', 'moderate')])

    db.command(cmd)

    db.malware_collection.create_index("id_malware")

def create_vt_collection(db):

    db.vt_collection.drop()
    db.create_collection("vt_collection")

    vexpr = {
        "$jsonSchema": {
            "bsonType": "object",
            "required": [ "id_vt" ],
            "properties": {
                "_id" : {
                    "bsonType": "objectId",
                },
                "id_vt" : {
                   "bsonType": "long",
                },
                "total_scan_vt" : {
                   "bsonType": "int",
                },
                "positives_vt" : {
                   "bsonType": "int",
                },
                "resource_vt" : {
                   "bsonType": "string",
                },
                "response_vt" : {
                   "bsonType": "int",
                },
                "scan_date_vt" : {
                   "bsonType": "date",
                },
                "permalink_vt" : {
                   "bsonType": "string",
                },
                "sha256_vt" : {
                   "bsonType": "string",
                },
                "md5_vt" : {
                  "bsonType": "string",
                },
                "id_labels_vt" : {
                   "bsonType": "objectId",
                },
                "id_malware_vt" : {
                   "bsonType": "objectId",
                }
            }
        }
    }

    cmd = OrderedDict([('collMod', 'vt_collection'),
            ('validator', vexpr),
        ('validationLevel', 'moderate')])

    db.command(cmd)


def create_label_collection(db):

    db.label_collection.drop()
    db.create_collection( "label_collection")

    vexpr = {
        "$jsonSchema": {
            "bsonType": "object",
            "required": [ "name_antivirus_label" ],
            "properties": {
                "_id" : {
                   "bsonType": "objectId",
                },
                "name_antivirus_label" : {
                   "bsonType": "string",
                },
                "id_malware_label" : {
                   "bsonType": "objectId",
                },
                "id_vt_label" : {
                   "bsonType": "objectId",
                }
            }                
        } 
    }

    cmd = OrderedDict([('collMod', 'label_collection'),
            ('validator', vexpr),
            ('validationLevel', 'moderate')])

    db.command(cmd)

def create_ip_collection(db):

    db.ip_collection.drop()
    db.create_collection( "ip_collection")

    vexpr = {
        "$jsonSchema": {
            "bsonType": "object",
            "required": [ "adress_ip" ],
            "properties": {
                "_id" : {
                   "bsonType": "objectId",
                },
                "address_ip" : {
                   "bsonType": "string",
                },
                "mask_ip" : {
                   "bsonType": "objectId",
                },
                "domain_ip" : {
                   "bsonType": "string",
                },
	        "geo_ip" : {
 	        "bsonType": "string",
	        },
	        "registar_ip" : {
 	        "bsonType": "string",
	        }
	    }                
        } 
    }

    cmd = OrderedDict([('collMod', 'ip_collection'),
        ('validator', vexpr),
        ('validationLevel', 'moderate')])

    db.command(cmd)

def test():

    try:
        okdoc = {"id_malware":"1", "source_malware":"test", "tags_malware":"test"}
        db.malware_collection.insert(okdoc)
        print("All good.")
    except:
        print("exc:", sys.exc_info())
