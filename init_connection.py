#!/usr/bin/env python

from pymongo import MongoClient
from collections import OrderedDict

import csv
import dateutil.parser
import json
import os
import sys
import subprocess
from subprocess import check_output
import time
import requests
import logging
from IP import *
from datetime import datetime
from add_to_database import *
from file_process import *
from vt_process import * 
TYPES = ['malware-url']
NAME = 'URLhaus'
DISABLED = False

def get_name_file_from_url(url):
    print("Searching for filename from url...")
    last_slash = url.rfind('/')
    return url[last_slash+1:]
    print("Done.")

def break_csv(lines):
    for line in lines:
        if line.startswith('#'):
            lines.remove(line)
    reader = csv.reader(lines, quotechar='"',delimiter=',',quoting=csv.QUOTE_ALL, skipinitialspace=True)
    next(reader)
    return reader 


def parse_csv_urlhaus(db, request):
    print("Parsing csv file from urlhaus...")
    url_list = []
    lines = request.text.split('\n')

    reader = break_csv(lines)
    count_stop = 0

    for item in reader:
        if len(item) > 1:
            
            count_stop =  count_stop + 1
            #toremove
           
           ### SAVE INFOS FROM CSV 
            id_malware = item[0]
            date_added = datetime.strptime(item[1], '%Y-%m-%d %H:%M:%S')
            url_malware = clean_url(item[2])
            if item[3] == "online":
                url_status = True
            else:
                url_status = False
            threat = item[4]
            tags = item[5]
            urlhaus_link = item[6]
            reporter = item[7]
            name_file = get_name_file_from_url(url_malware)
            

          ### CHECK EXISTENCE IN DATABASE
            if id_malware_exist(db, id_malware) == False:

                add_malware_collection(id_malware, "urlhaus", date_added, url_malware, url_status, threat, tags,urlhaus_link, reporter, name_file) # miss ip_malware, rapport_vt_malware, imphash_malware, is_exe_malware, ssdeep_malware, sha1_malware, sha256_malware 
                ip, country_name, country_code, continent_name, continent_code, region_name, region_code, city, zip, latitude, longitude, full_report = get_ip_geo_from_url(url_malware) 
                add_ip_collection(id_malware, ip, country_name, country_code, continent_name, continent_code, region_name, region_code, city, zip, latitude, longitude, str(full_report))
                ### CHECK IF ONLINE OR OFFLINE
                if url_status == True:
                    
                    ### SAVE FILE
                    id_file = file_from_url_to_gridfs(db, url_malware, name_file)
                    if id_file is not None:
                        db.malware_collection.update( { "id_malware":id_malware },  {"$set" : {"id_file_malware": id_file } } )
                        md5_file = get_file_from_gridfs(db, id_file).md5
                        if md5_file is not None:
                            db.malware_collection.update( { "id_malware":id_malware }, {"$set" : {"md5_malware": md5_file } } )
                        
                            vt_report = get_virustotal(md5_file)
                            if vt_report is not None:
                                add_vt_collection(vt_report['scan_id'], vt_report['total'], vt_report['positives'], vt_report['resource'], vt_report['response_code'], vt_report['scan_date'], vt_report['permalink'], vt_report['sha256'], vt_report['md5'], vt_report['sha1'], str(vt_report), id_malware)

                                os.chdir('avclassplusplus/')
                                save_labels(id_malware)
                                save_vt_report(vt_report, id_malware)
                                os.chdir('../')

            else:
                print ("File ID " + id_malware + " already in DB")
                
            if count_stop == 110:
                return


def save_labels(id_malware):
    p = subprocess.Popen(['python3', 'avclass_labeler.py', '-vt', 'report/' + id_malware + '.report'], stdout=subprocess.PIPE)
    out, err = p.communicate()
    print("OUT:" + str(out))



def init_connection_urlhaus():
    try:
        logging.info('Fetching latest URLhaus list...')
        request = requests.get('https://urlhaus.abuse.ch/downloads/csv_recent/')
        if request.status_code == 200:
            logging.info('Processing URLhaus list...')
            return request
        else:
            logging.error('Problem connecting to URLhaus. Status code:{0}. Please try again later.'.format(request.status_code))

    except requests.exceptions.ConnectionError as e: logging.warning('Problem connecting to URLhaus. Error: {0}'.format(e))

    except Exception as e:
        logging.warning('Problem connecting to URLhaus. Aborting task.')
        logging.exception(sys.exc_info())
        logging.exception(type(e))
        logging.exception(e.args)
        logging.exception(e)

    return []


def clean_url(url):
    """Remove extraneous characters from URL.
    Params:
    - url: (type: string) URL to clean.
    Returns:
    - url: (type: string) clean URL.
    """

    if url is None:
        return None

    if '??' in url:
        url = url.split('??')[0]

    if url.endswith('?'):
        url = url[:-1]

    if '`' in url:
        url = url.replace('`', '')

    return url

