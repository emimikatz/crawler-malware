#!/usr/bin/env python

from pymongo import MongoClient
from collections import OrderedDict

import csv
import dateutil.parser
import json
import os
import sys
import time
import requests
import logging
from datetime import datetime
from add_to_database import *

TYPES = ['malware-url']
NAME = 'URLhaus'
DISABLED = False


def parse_csv_urlhaus(request):
    url_list = []
    lines = request.text.split('\n')

    for line in lines:
        if line.startswith('#'):
            lines.remove(line)
    reader = csv.reader(lines, quotechar='"',delimiter=',',quoting=csv.QUOTE_ALL, skipinitialspace=True)
    next(reader)

    for item in reader:
        if len(item) > 1:
            id_malware = item[0]
            date_added = datetime.strptime(item[1], '%Y-%m-%d %H:%M:%S')
            url_malware = clean_url(item[2])
            if item[3] == "online":
                url_status = True
            else:
                url_status = False
            threat = item[4]
            tags = item[5]
            urlhaus_link = item[6]
            reporter = item[7]
            add_malware_collection(id_malware, "urlhaus", date_added, url_malware, url_status, threat, tags,urlhaus_link, reporter)


def init_connection_urlhaus():
    try:
        logging.info('Fetching latest URLhaus list...')
        request = requests.get('https://urlhaus.abuse.ch/downloads/csv_recent/')
        if request.status_code == 200:
            logging.info('Processing URLhaus list...')
            parse_csv_urlhaus(request)
        else:
            logging.error('Problem connecting to URLhaus. Status code:{0}. Please try again later.'.format(request.status_code))

    except requests.exceptions.ConnectionError as e: logging.warning('Problem connecting to URLhaus. Error: {0}'.format(e))

    except Exception as e:
        logging.warning('Problem connecting to URLhaus. Aborting task.')
        logging.exception(sys.exc_info())
        logging.exception(type(e))
        logging.exception(e.args)
        logging.exception(e)

    return []


def clean_url(url):
    """Remove extraneous characters from URL.
    Params:
    - url: (type: string) URL to clean.
    Returns:
    - url: (type: string) clean URL.
    """

    if url is None:
        return None

    if '??' in url:
        url = url.split('??')[0]

    if url.endswith('?'):
        url = url[:-1]

    if '`' in url:
        url = url.replace('`', '')

    return url

