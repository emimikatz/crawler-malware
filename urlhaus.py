#!/usr/bin/env python

from pymongo import MongoClient
from collections import OrderedDict
import sys
from add_to_database import * 

def init_connection_urlhaus():
	"""Produce a list of malware URLs from the URLhaus feed.
    	Returns:
    	- url_list: (type: MalwareUrl list) list of malware URLs.
    	"""
    	try:
        	logging.info('Fetching latest URLhaus list...')
        	request = requests.get('https://urlhaus.abuse.ch/downloads/csv_recent/')
        	if request.status_code == 200:
            		logging.info('Processing URLhaus list...')
			parse_csv(request)
                else:
            		logging.error('Problem connecting to URLhaus. Status code:{0}. Please try again later.'.format(request.status_code))

    	except requests.exceptions.ConnectionError as e:
        logging.warning('Problem connecting to URLhaus. Error: {0}'.format(e))

    	except Exception as e:
		logging.warning('Problem connecting to URLhaus. Aborting task.')
		logging.exception(sys.exc_info())
		logging.exception(type(e))
		logging.exception(e.args)
		logging.exception(e)

	return []


def parse_csv_urlhaus(request)
	url_list = []
        lines = request.text.split('\n')

        for line in lines:
        	if line.startswith('#'):
                	lines.remove(line)

        	reader = csv.reader(lines, quotechar='"',delimiter=',',quoting=csv.QUOTE_ALL, skipinitialspace=True)
            	next(reader)

        for item in reader:
                if len(item) > 1:
                    id_malware = item[0]
                    date_added = item[1]
                    url_malware = clean_url(item[2])
                    url_status = item[3]
                    threat = item[4]
                    tags = item[5]
                    urlhaus_link = item[6]
		    reporter = item[7]
                    add_malware_table(id_malware, "urlhaus", date_added, url_malware, url_statuts, threat_tags,urlhaus_link, reporter)
                if url is None or len(url) == 0:
                        continue


