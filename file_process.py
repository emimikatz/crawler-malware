import urllib.request
import os
import hashlib
import ssdeep
import pefile
import json
import requests
from virustotal_python import Virustotal

dir_path = os.path.dirname(os.path.realpath(__file__))

def get_md5(fname):
    hash_md5 = hashlib.md5()
    with open(fname, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_md5.update(chunk)
        return hash_md5.hexdigest()

def get_sha256(fname):
    hash_sha256 = hashlib.sha256()
    with open(fname, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_sha256.update(chunk)
        return hash_sha256.hexdigest()

def get_sha1(fname):
    hash_sha1 = hashlib.sha1()
    with open(fname, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_sha1.update(chunk)
        return hash_sha1.hexdigest()

def get_ssdeep(fname):
    hash_ssdeep = ssdeep.Hash()
    with open(fname, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_ssdeep.update(chunk)
        return hash_ssdeep.digest()

def is_exe(fname):
    if fname[-1] == 'e':
        if fname[-2] == 'x':
            if fname[-3] == 'e':
                if fname[-4] == '.':
                    return True
                return False

def get_imphash(fname):
    if is_exe(fname):
        imps = []
        p = pefile.PE(fname)
        imphash = p.get_imphash()
        imps.append(imphash)
        return imps

def get_virustotal(fname, md5):
    url_report = 'https://www.virustotal.com/vtapi/v2/file/report'
    params_report = {'apikey': '628efd0ccafa70545a87bff6b23330a9642e8c58bef203520a57051c298d4518', 'resource': md5}
    response_report = requests.get(url_report, params=params_report)
    response_json = response_report.json() 
    if not response_json['verbose_msg'] == "Scan finished, information embedded":
        url_scan = 'https://www.virustotal.com/vtapi/v2/file/scan'
        params_scan = {'apikey':'628efd0ccafa70545a87bff6b23330a9642e8c58bef203520a57051c298d4518'}
        files_scan = {'file': (fname, open(fname, 'rb'))}
        response_scan = requests.post(url2, files=files_scan, params=params_scan)
        response_json = response_scan.json()
    else:
        total = response_json['total']
        positives = response_json['positives']
    scan_id = response_json['scan_id']
    sha1 = response_json['sha1']
    resource = response_json['resource']
    response_code = response_json['response_code']
    scan_date = response_json['scan_date']
    permalink = response_json['permalink']
    sha256 = response_json['sha256']
    md5 = response_json['md5']
    return response_json


def main():
    url = 'http://okehieugochukwucassperkroosdavid.duckdns.org/vbc.exe'
    urllib.request.urlretrieve(url, dir_path + '/malwares/vbc.exe')
    md5_virus = get_md5(dir_path + '/malwares/vbc.exe')
    sha256_virus = get_sha256(dir_path + '/malwares/vbc.exe')
    sha1_virus = get_sha1(dir_path + '/malwares/vbc.exe')
    ssdeep_virus = get_ssdeep(dir_path + '/malwares/vbc.exe')
    if is_exe(dir_path + '/malwares/vbc'):
        imphash_virus = get_imphash(dir_path + '/malwares/vbc.exe')
    else:
        print("Pas de imphash.")
    json_virustotal = get_virustotal(dir_path + '/malwares/vbc.exe', md5_virus)
    first = json_virustotal['scans']
    
    strr = '{"sha1": "' + json_virustotal['sha1'] + '", "av_labels": ['
    for k,v in first.items():
        antivirus = k
        json_antivirus = v
        for k2,v2 in json_antivirus.items():
            if k2 == "result" and str(v2) != "None":
              strr = strr + '["' + str(antivirus) + '", "' + str(v2) + '"] ,'
    strr = strr[:-2]
    strr = strr + ']'
    strr = strr + ', "scan_date": "' + json_virustotal['scan_date'] + '"'
    strr = strr + ', "sha256": "' + json_virustotal['sha256'] + '"'
    strr = strr + ', "md5": "' + json_virustotal['md5'] + '"}'

    fichier = open("test.json", "w")
    fichier.write(strr)
    fichier.close()
    print(strr)

if __name__ == "__main__":
    main()

