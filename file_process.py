import urllib.request
import gridfs
import os
import hashlib
import ssdeep
import pefile
import json
import requests
import mimetypes
from init_database import *
from init_connection import *
from virustotal_python import Virustotal

dir_path = os.path.dirname(os.path.realpath(__file__))

def is_exe(fname):
    if fname[-1] == 'e':
        if fname[-2] == 'x':
            if fname[-3] == 'e':
                if fname[-4] == '.':
                    return True
                return False

def get_md5(db, fpath, fname):
    print("Searching for md5 of file " + fname)
    file_from_db_to_hd(db, fpath, fname)
    hash_md5 = hashlib.md5()
    with open(fpath + fname, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_md5.update(chunk)
    os.remove(fpath + fname)
    rslt = hash_md5.hexdigest()
    print("The md5 is " + rslt)
    return rslt

def get_sha256(db, fpath, fname):
    print("Searching for sha256 of file " + fname)
    file_from_db_to_hd(db, fpath, fname)
    hash_sha256 = hashlib.sha256()
    with open(fpath + fname, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_sha256.update(chunk)
    os.remove(fpath + fname)
    rslt = hash_sha256.hexdigest()
    print("The sha256 is " + rslt)
    return rslt


def get_sha1(db, fpath, fname):
    print("Searching for sha1 of file " + fname)
    file_from_db_to_hd(db, fpath, fname)
    hash_sha1 = hashlib.sha1()
    with open(fpath + fname, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_sha1.update(chunk)
    os.remove(fpath + fname)
    rslt = hash_sha1.hexdigest()
    print("The sha1 is " + rslt)
    return rslt

def get_ssdeep(db, fpath, fname):
    print("Searching for ssdeep of file " + fname)
    file_from_db_to_hd(db, fpath, fname)
    hash_ssdeep = ssdeep.Hash()
    with open(fpath + fname, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_ssdeep.update(chunk)
    os.remove(fpath + fname)
    rslt = hash_ssdeep.hexdigest()
    print("The ssdeep is " + rslt)
    return rslt


def get_imphash(db, fpath, fname):
    print("Searching for impash of file " + fname)
    file_from_db_to_hd(db, fpath, fname)
    if is_exe(fpath + fname):
        imps = []
        p = pefile.PE(fpath + fname)
        imphash = p.get_imphash()
        imps.append(imphash)
        os.remove(fpath + fname)
        print("The imphash is " + imps)
        return imps

def file_from_url_to_gridfs(db, url, file_name):
    print("put file from " + url + " to gridfs db")
    fs = gridfs.GridFS(db)
    request = requests.get(url, stream=True)
    mime_type = mimetypes.guess_type(url)
    _id = fs.put(request.raw, contentType=mime_type, filename=file_name)
    print("Done.")
    return _id
    
def file_from_db_to_hd(db, fpath, fname):
    print("put file " + fname + " from Gridfs to hard disk to " + fpath)
    fs = gridfs.GridFSBucket(db)
    file = open(fpath + fname, 'wb')
    fs.download_to_stream_by_name(fname, file)
    print("Done.")

"""rapport virustotal en json, dump"""
def vt_to_json(vt, fpath, fname):
    with open(ftpath + fname, "w") as outfile:
        json.dump(vt, outfile)
        outfile.close()

""" afficher la liste des fichiers dans la bdd"""
def print_gridfs(db):
    print(" \n\n/// PRINT GRIDFS /// ")
    fs = gridfs.GridFSBucket(db)
    for gridout in fs.find():
        print("\n_id: " + str(gridout._id) + "\nfilename: " + str(gridout.filename) + "\ncontent_type: " + str(gridout.contentType) + "\nchunkSize: " + str(gridout.chunkSize) + " bytes")
    print(" /// END PRINT GRIDFS /// ")

def erase_gridfs(db):
    print(" \n\n/// ERASING GRIDFS /// ")
    fs = gridfs.GridFSBucket(db)
    for gridout in fs.find():
        print("...")
        fs.delete(gridout._id)
    print(" /// END ERASING GRIDFS /// ")

def print_database(db):
    print(" \n\n/// PRINT MONGO DB /// ")
    collection = db['malware_collection']
    cursor = collection.find({})
    for document in cursor:
        print(document)
    print(" /// END PRINT MONGO DB /// ")

def main():
    init_mongo();
    db = connect_database()
    erase_gridfs(db);
    request = init_connection_urlhaus()
    parse_csv_urlhaus(db, request)
    
    print_gridfs(db)
    print_database(db)

if __name__ == "__main__":
    main()
