#!/usr/bin/env python

from pymongo import MongoClient
from collections import OrderedDict
import sys

def init_mongo()
    client = MongoClient('mongodb+srv://admin:crawlermalware@cluster0-uzcfx.mongodb.net/test?retryWrites=true&w=majority')
    db = client.crawler_malware
    return db

def create_collections()
    db.malware_table.drop()
    db.create_collection( "malware_table")

    vexpr = {
        "$jsonSchema": {
            "bsonType": "object",
            "required": [ "id_malware" ],
            "properties": {
                "_id": {
                "bsonType": "objectId",
                },
                "id_malware": {
                "bsonType": "string",
	    },
	    "source_malware": {
 	    "bsonType": "string",
	    },
	    "date_added_malware": {
 	    "bsonType": "date",
	    },
	    "url_malware": {
 	    "bsonType": "string",
	    },
	    "url_status_malware": {
 	    "bsonType": "bool",
	    },
	    "threat_malware": {
 	    "bsonType": "string",
	    },
	    "tags_malware": {
 	    "bsonType": "string",
	    },
	    "url_haus_malware": {
 	    "bsonType": "string",
	    },
	    "reporter_malware": {
 	    "bsonType": "string",
	    },
	    "md5_malware": {
 	    "bsonType": "string",
	    },
	    "sha256_malware": {
 	    "bsonType": "string",
	    },
	    "sha1_malware": {
 	    "bsonType": "string",
	    },
	    "ssdeep_malware": {
 	    "bsonType": "string",
	    },
	    "is_exe_malware": {
 	    "bsonType": "bool",
	    },
	    "imphash_malware": {
 	    "bsonType": "string",
	    },
	    "rapport_vt_malware": {
 	    "bsonType": "objectId",
	    },
	    "ip_malware": {
 	    "bsonType": "objectId",
	    }
	}                
    } 
}

cmd = OrderedDict([('collMod', 'malware_table'),
        ('validator', vexpr),
        ('validationLevel', 'moderate')])

db.command(cmd)


db.vt_table.drop()
db.create_collection("vt_table")

vexpr = {
    "$jsonSchema": {
        "bsonType": "object",
        "required": [ "id_vt" ],
        "properties": {
    	    "_id" : {
 	        "bsonType": "objectId",
	    },
	    "id_vt" : {
 	       "bsonType": "long",
	    },
	    "total_scan_vt" : {
 	       "bsonType": "int",
	    },
	    "positives_vt" : {
 	       "bsonType": "int",
	    },
	    "resource_vt" : {
 	       "bsonType": "string",
	    },
	    "response_vt" : {
 	       "bsonType": "int",
	    },
	    "scan_date_vt" : {
 	       "bsonType": "date",
	    },
	    "permalink_vt" : {
 	       "bsonType": "string",
	    },
	    "sha256_vt" : {
 	       "bsonType": "string",
	    },
	    "md5_vt" : {
 	      "bsonType": "string",
	    },
	    "id_labels_vt" : {
 	       "bsonType": "objectId",
	    },
	    "id_malware_vt" : {
 	       "bsonType": "objectId",
	    }
	}
    }
}

cmd = OrderedDict([('collMod', 'vt_table'),
        ('validator', vexpr),
        ('validationLevel', 'moderate')])

db.command(cmd)


db.label_table.drop()
db.create_collection( "label_table")

vexpr = {
    "$jsonSchema": {
        "bsonType": "object",
        "required": [ "name_antivirus_label" ],
        "properties": {
    	    "_id" : {
 	       "bsonType": "objectId",
	    },
            "name_antivirus_label" : {
 	       "bsonType": "string",
	    },
	    "id_malware_label" : {
 	       "bsonType": "objectId",
	    },
	    "id_vt_label" : {
 	       "bsonType": "objectId",
            }
	}                
    } 
}

cmd = OrderedDict([('collMod', 'label_table'),
        ('validator', vexpr),
        ('validationLevel', 'moderate')])

db.command(cmd)

db.ip_table.drop()
db.create_collection( "ip_table")

vexpr = {
    "$jsonSchema": {
        "bsonType": "object",
        "required": [ "adress_ip" ],
        "properties": {
    	    "_id" : {
 	       "bsonType": "objectId",
	    },
            "address_ip" : {
 	       "bsonType": "string",
	    },
	    "mask_ip" : {
 	       "bsonType": "objectId",
	    },
	    "domain_ip" : {
 	       "bsonType": "string",
	    },
	    "geo_ip" : {
 	       "bsonType": "string",
	    },
	    "registar_ip" : {
 	       "bsonType": "string",
	    }
	}                
    } 
}

cmd = OrderedDict([('collMod', 'ip_table'),
        ('validator', vexpr),
        ('validationLevel', 'moderate')])

db.command(cmd)

try:
    okdoc = {"id_malware":"1", "source_malware":"test", "tags_malware":"test"}
    db.malware_table.insert(okdoc)
    print("All good.")
except:
    print("exc:", sys.exc_info())
