#!/usr/bin/env python

import os
import time

from init_connection import *
from init_database import *
from vt_process import *
from request_database import *

from threading import Thread 

dir_path = os.path.dirname(os.path.realpath(__file__))

def main():
    """
    Fonction Main
    init, -- Clean the database
download, -- Crawler runs, parses the csv file, collects information from the different files and stores them in the Mongo database
count, -- Summary of processed files in the database
print, -- List elements present in the database
    """
    input_user = input("Enter value\n")
    print("Enter 'run' to download files from urlhaus")
    print("Enter 'init' to initializate the database")
    print("Enter 'print' to print the database")
    print("Enter 'count' to count everything in database")
    print("Enter 'md5', 'sha256', 'sha1', 'ssdeep' or 'imphash' to make a request to the database")
    
    client, db = connect_database() 

    if input_user == "init":
        os.system("celery -A init_connection purge -f")
        init_mongo()
    elif input_user == "run":
        Thread(target=periodic_vt, daemon=True).start()
        Thread(target=periodic_link, daemon=True).start()
        request = init_connection_urlhaus()
        parse_csv_urlhaus(db, request)
    elif input_user == "count":
        count_gridfs(db)
        count_database(db)
    elif input_user == "print":
        print_gridfs(db)
        print_database(db)
    elif input_user == "md5" or input_user == "sha256" or input_user == "sha1" or input_user == "ssdeep" or input_user == "imphash" :
        type_hash = input_user
        input_user = input("Enter hash\n")
        get_hash_malware(db, type_hash, input_user)
    client.close()


if __name__ == "__main__":
    main()
