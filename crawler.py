#!/usr/bin/python3

import csv
import dateutil.parser
import json
import os
import sys
import time
import requests
import logging

TYPES = ['malware-url']
NAME = 'URLhaus'
DISABLED = False

def clean_url(url):
    """Remove extraneous characters from URL.
    Params:
    - url: (type: string) URL to clean.
    Returns:
    - url: (type: string) clean URL.
    """

    if url is None:
        return None

    if '??' in url:
        url = url.split('??')[0]

    if url.endswith('?'):
        url = url[:-1]

    if '`' in url:
        url = url.replace('`', '')

    return url


def get_malwareurl_list():
    """Produce a list of malware URLs from the URLhaus feed.
    Returns:
    - url_list: (type: MalwareUrl list) list of malware URLs.
    """
    try:

        logging.info('Fetching latest URLhaus list...')

        request = requests.get(
            'https://urlhaus.abuse.ch/downloads/csv_recent/')
        if request.status_code == 200:
            logging.info('Processing URLhaus list...')

            url_list = []
            lines = request.text.split('\n')

            for line in lines:
                if line.startswith('#'):
                    lines.remove(line)

            reader = csv.reader(
                lines,
                quotechar='"',
                delimiter=',',
                quoting=csv.QUOTE_ALL,
                skipinitialspace=True)
            next(reader)

            for item in reader:
                if len(item) > 1:
                    id_malware = item[0]
                    date_added = item[1]
                    url_malware = clean_url(item[2])
                    url_status = item[3]
                    threat = item[4]
                    tags = item[5]
                    urlhaus_link = item[6]
                    reporter = item[7]
                    if url is None or len(url) == 0:
                        continue

                    print(url)

            return url_list

        else:
            logging.error(
                'Problem connecting to URLhaus. Status code:{0}. Please try again later.'.format(
                    request.status_code))

    except requests.exceptions.ConnectionError as e:
        logging.warning('Problem connecting to URLhaus. Error: {0}'.format(e))

    except Exception as e:
        logging.warning('Problem connecting to URLhaus. Aborting task.')
        logging.exception(sys.exc_info())
        logging.exception(type(e))
        logging.exception(e.args)
        logging.exception(e)

    return []

def main():
     get_malwareurl_list()

if __name__ == "__main__":
    # execute only if run as a script
    main()


