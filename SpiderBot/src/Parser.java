import java.io.File;
import java.io.IOException;


/*
import java.net.URL;
import java.io.BufferedReader;
import java.io.InputStreamReader;
*/

import java.util.ArrayList;
import java.util.Arrays;

import org.xml.sax.ErrorHandler;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import java.io.File;


/*import org.jsoup.Jsoup;
import org.jsoup.helper.Validate;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;*/



import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class Parser {


	
	/* param  : String[] args = les arguments du programme java
	 * return : true si les 2 arguments corresponde respectivement a sources.xml et words.xml,
	 * 		    false sinon
	 * */
	public static boolean input_files_check(String[] args) {
		
		if ( args.length != 2 ) return false;
		
		File sources = new File(args[0]);
		File words   = new File(args[1]);
		if ( !sources.exists() || !words.exists() ) return false;
		
		return true;
	}
	
	
	/* Parse the arguments given to the program : --sources, --words, --output, --debug */
	public static void parse_args(String[] args)
	{
		int len = args.length; 
		Boolean debug = false;
		String sources	= null,
				words	= null,
				output	= null;
		String error_message = "Syntax Error : java bot \n" +
							   "                         mandatory :  --sources \"path to sources.xml\" \n" +
							   "                                      --words   \"path to words.xml\" \n"   +
							   "                         optional  :  --debug   \"true or false (by default)\" \n" + 
							   "                                      --output  \"path to output.xml (by default)\" ";

		if ( len != 8   &&   len != 6   &&    len != 4 ) /* if not enough args, quit the program */
		{
			System.out.println(error_message);
			System.exit(-1); 
		}
		
		/* mandatory args : --sources & --words */
		if ( Arrays.asList(args).contains("--sources")  && Arrays.asList(args).contains("--words") ) /* 2 mandatory arguments : --sources & --words */
		{
			sources = args[Arrays.asList(args).indexOf("--sources")+1];
			words = args[Arrays.asList(args).indexOf("--words")+1];
		}
		
		else /* exit if mandatory args are not used */
		{	
			System.out.println(error_message);
			System.exit(-1); 
		}
		
		
		/* optional arg : --output */
		if ( Arrays.asList(args).contains("--output") )
		{
			output = args[Arrays.asList(args).indexOf("--output")+1];
		}
		
		/* optional arg : --debug */
		if ( Arrays.asList(args).contains("--debug") )
		{
			if ( args[Arrays.asList(args).indexOf("--debug")+1].equals("true") )
			{
				debug = true;
			}
			else if ( args[Arrays.asList(args).indexOf("--debug")+1].equals("false") )
			{
				debug = false;
			}
			else
			{
				System.out.println(error_message);
				System.exit(-1);
			}	
		}	
		
			
		Main.debug = debug;
		Main.sources_file = sources;
		Main.words_file = words;
		Main.output_file = output;	
	}
	
	
	
	/* param  : String sources_filename = fichier XML qui contient les sources
	 * return : liste des sources choisit par l'utilisateur 
	 */
	public static ArrayList<Source>  parse_sources(String sources_filename) {
		
		ArrayList<Source> sources = new ArrayList<Source>();
		
		
		
		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
		factory.setIgnoringElementContentWhitespace(true);
		
		try {
			DocumentBuilder builder = factory.newDocumentBuilder();
			
			factory.setValidating(true);
			ErrorHandler errHandler = new SimpleErrorHandler();
			builder.setErrorHandler(errHandler);
			
			File fileXML = new File(sources_filename);
			
			try {
				org.w3c.dom.Document xml = builder.parse(fileXML);
				xml.getDocumentElement().normalize();
				org.w3c.dom.Element root = xml.getDocumentElement();
				
				
				
				org.w3c.dom.NodeList nList = root.getElementsByTagName("source");
				
				for ( int i=0 ; i<nList.getLength() ; i++ )
				{
					org.w3c.dom.Node nNode = nList.item(i);
					org.w3c.dom.Element e = (org.w3c.dom.Element) nNode;;
					
					if (nNode.getNodeType() == org.w3c.dom.Node.ELEMENT_NODE ) {
						
						boolean choosen = (e.getAttribute("choosen").equals("true")) ? true : false;
						String url = e.getElementsByTagName("url").item(0).getTextContent();
						String pattern = e.getElementsByTagName("pattern").item(0).getTextContent();
						String country = e.getElementsByTagName("country").item(0).getTextContent();
						String label = e.getElementsByTagName("label").item(0).getTextContent();
						
						
						Source source = new Source(choosen,url,pattern,country,label);
						sources.add(source);
					}
				}
				
			
				
			} catch (SAXParseException e) {
				e.printStackTrace();
			}
		
			
			
			
			
			
			
		} catch (ParserConfigurationException e) {
			e.printStackTrace();
		} catch (SAXException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}

		
	
		return sources;
	}

	
	
	
	/* param  : String sources_filename = fichier XML qui contient les sources
	 * return : liste des sources choisit par l'utilisateur 
	 */
	public static ArrayList<Word>  parse_words(String words_filename) {
		
		ArrayList<Word> words = new ArrayList<Word>();
		
		
		
		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
		factory.setIgnoringElementContentWhitespace(true);
		
		try {
			DocumentBuilder builder = factory.newDocumentBuilder();
			
			factory.setValidating(true);
			ErrorHandler errHandler = new SimpleErrorHandler();
			builder.setErrorHandler(errHandler);
			
			File fileXML = new File(words_filename);
			
			try {
				org.w3c.dom.Document xml = builder.parse(fileXML);
				xml.getDocumentElement().normalize();
				org.w3c.dom.Element root = xml.getDocumentElement();
				
				
				
				org.w3c.dom.NodeList nList = root.getElementsByTagName("word");
				
				for ( int i=0 ; i<nList.getLength() ; i++ )
				{
					org.w3c.dom.Node nNode = nList.item(i);
					org.w3c.dom.Element e = (org.w3c.dom.Element) nNode;;
					
					if ( nNode.getNodeType() == org.w3c.dom.Node.ELEMENT_NODE ) {
						
						boolean used = (e.getAttribute("used").equals("true")) ? true : false;
						String raw = e.getElementsByTagName("raw").item(0).getTextContent();
						String clean = e.getElementsByTagName("clean").item(0).getTextContent();
						

						Word word = new Word(used,raw,clean);
						words.add(word);
					}
				}
				
			
				
			} catch (SAXParseException e) {
				e.printStackTrace();
			}
		
			
			
			
			
			
			
		} catch (ParserConfigurationException e) {
			e.printStackTrace();
		} catch (SAXException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}

		
	
		return words;
	}
	
	
	/* param  : ArrayList of sources
	 * return : liste des sources choisit par l'utilisateur 
	 */

	

  	public static void parse_articles(ArrayList<Source> sources) throws IOException 
 
	{
		
  		try
  		{
  			DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
			DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
	        Document doc = dBuilder.newDocument();
	        
	        Element rootElement = doc.createElement("articles");
	        doc.appendChild(rootElement);

		
			for ( int i=0 ; i<sources.size()-1 ; i++ )
			{
				if ( ! sources.get(i).isChoosen() ) continue; 
				if ( Main.debug ) System.out.println("\t" + sources.get(i).getUrl());
							
				org.jsoup.nodes.Document html = org.jsoup.Jsoup.connect(sources.get(i).getUrl()).get().normalise();;
				String htmlContent = html.toString();
				
				org.jsoup.select.Elements links = ((org.jsoup.nodes.Element) html).select("body a[href]");  //*:not(header),*:not(footer)
				//System.out.println("\t\t" + links.size() + " links");
				
				Pattern pattern = Pattern.compile(sources.get(i).getPattern());
				
			    
				for (org.jsoup.nodes.Element link : links)
				{
					String abs_href = link.attr("abs:href");
					Matcher matche = pattern.matcher(abs_href);
					if ( ! matche.matches() ) continue;
					
					//System.out.println("#"+link.attr("abs:href"));
					
					/* writing links into output.xml */
					Element article = doc.createElement("article");
			        rootElement.appendChild(article);
				   
			        Element source = doc.createElement("source");
				    article.appendChild(source);
					
				    Element sub_url = doc.createElement("url");
				    sub_url.appendChild(doc.createTextNode(sources.get(i).getUrl()));
					source.appendChild(sub_url);
					Element label = doc.createElement("label");
					label.appendChild(doc.createTextNode(sources.get(i).getLabel()));
					source.appendChild(label);
					
					Element text = doc.createElement("text");
					article.appendChild(text);
					
					Element raw = doc.createElement("raw");
					raw.appendChild(doc.createTextNode("RaW"));
					text.appendChild(raw);
					Element clean = doc.createElement("clean");
					clean.appendChild(doc.createTextNode("clean"));
					text.appendChild(clean);
					
					Element url = doc.createElement("url");
					url.appendChild(doc.createTextNode("--"));//abs_href);
					article.appendChild(url);
					
					Element img = doc.createElement("img");
					img.appendChild(doc.createTextNode(sources.get(i).getUrl()+"/image.png"));
					article.appendChild(img);
						    
					Element tags = doc.createElement("tags");
					article.appendChild(tags);
					
					Element tag = doc.createElement("tag");
					tag.appendChild(doc.createTextNode("tag"));
					tags.appendChild(tag);
					    
					
	

				    
				}
				
			}
			
			TransformerFactory transformerFactory = TransformerFactory.newInstance();
			Transformer transformer = transformerFactory.newTransformer();
			DOMSource in = new DOMSource(doc);
			StreamResult result = new StreamResult(new File("../data/output.xml"));
			transformer.transform(in, result);
  		
			
  		} catch (Exception e) {
  	         e.printStackTrace();
  		}
	}


	
	/*
	 * public static ArrayList<Article> getAllArticles(String url, String regex) throws IOException {
		ArrayList<Article> articles = new ArrayList<Article>();
		Document html = (Document) Jsoup.connect(url).get().normalise();
		
		int index = url.indexOf('.');
		String url_clean = url.substring(index+1);
		
		int count = 0;
//		Elements links = ((org.jsoup.nodes.Element) html).select("body a");  //*:not(header),*:not(footer)
		ArrayList<String> l = new ArrayList<String>();
		
		for (org.jsoup.nodes.Element link : links)
		{ 
			String abs_href = link.attr("abs:href");
			String request = "http[s]?://.{0,10}url.*regex".replace("url",url_clean).replace("regex", regex);
			
			//String regex = "http[s]?://.{0,10}url.*[\\d]{4}/[\\d]{2}/[\\d]{2}/.*html".replace("url",url_clean); //lemonde
			//String regex = "http[s]?://.{0,10}url.*N[\\d]{5,7}".replace("url",url_clean); // usine nouvelle
			//String regex = "http[s]?://.{0,10}url.*[\\d]{4}/[\\d]{2}/[\\d]{2}/".replace("url", url_clean);
			
			if ( ! abs_href.matches(request) ) continue;
			
			String sourceURL = url;
			String sourceLabel = "none";
			String txt = link.select("h1, h2, h3, h4, h5, h6").text();
			String img = link.select("img").attr("src").toString();
			String href = abs_href;
			
			Article article = new Article(sourceURL,sourceLabel,txt,img,href);
			articles.add(article);
			//System.out.println(link.attr("href"));
			
			System.out.println(count + ") href : " + link.attr("abs:href"));
			l.add(link.attr("href").toString()); 
			count++;
			
		}
		

		System.out.println("COUNT = " + count + " for URL = " + url);
		return articles;
	}
	
	 * public static void parse() {
		
		System.out.println("START PARSING");
		System.out.println("---------------------------------");
		
		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
		factory.setIgnoringElementContentWhitespace(true);
		
		try {
			DocumentBuilder builder = factory.newDocumentBuilder();
			
			factory.setValidating(true);
			ErrorHandler errHandler = new SimpleErrorHandler();
			builder.setErrorHandler(errHandler);
			
			File fileXML = new File("src/NewFile.xml");
			
			try {
				org.w3c.dom.Document xml = builder.parse(fileXML);
				xml.getDocumentElement().normalize();
				org.w3c.dom.Element root = xml.getDocumentElement();
				
				System.out.println("Root : "+root.getNodeName());
				System.out.println("---------------------------------");
				
				org.w3c.dom.NodeList sources = root.getElementsByTagName("source");
				
				for ( int i=0 ; i<sources.getLength() ; i++ )
				{
					org.w3c.dom.Node source = sources.item(i);
					System.out.print("Curr_Element : "+source.getNodeName()+" --> choosen:");
				
					
					if (source.getNodeType() == org.w3c.dom.Node.ELEMENT_NODE) {
						org.w3c.dom.Element e = (org.w3c.dom.Element) source;
						
						System.out.println(e.getAttribute("choosen"));
						
						System.out.println("\t"+"url : "+e.getElementsByTagName("url").item(0).getTextContent());
						System.out.println("\t"+"pattern : "+e.getElementsByTagName("pattern").item(0).getTextContent());
						System.out.println("\t"+"country : "+e.getElementsByTagName("country").item(0).getTextContent());
						System.out.println("\t"+"label : "+e.getElementsByTagName("label").item(0).getTextContent());
						
					}
				}
				
					
			} catch (SAXParseException e) {}
		
			
			
			
			
			
			
		} catch (ParserConfigurationException e) {
			e.printStackTrace();
		} catch (SAXException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}

		
		System.out.println("---------------------------------");
		System.out.println("END PARSING");
	}
	
	

	
	
public static ArrayList<Article> getAllArticle_v2(String url) throws IOException {
		
		ArrayList<Article> articles = new ArrayList<Article>();
		Document html = (Document) Jsoup.connect(url).get();

		String request = "a[href], " +
						 "a:has(img,h1,h2,h3,h4,h5,h6,p)";  
		
		Elements links = ((org.jsoup.nodes.Element) html).select(request);
		
		
		for (org.jsoup.nodes.Element link : links)
		{ 
			 
			String sourceURL = url;
			String sourceLabel = "none";
			String txt = link.select("h1, h2, h3, h4, h5, h6").text();
			String img = link.select("img").attr("src").toString();
			String href = link.attr("href");
			
			Article article = new Article(sourceURL,sourceLabel,txt,img,href);
			articles.add(article);
			System.out.println("href= " + link.attr("abs:href"));
		}
		
		
		
		
		
		return articles;
}
	*/
/*
	public static ArrayList<Article> getArticleWithKeyword(String url, String word) throws IOException {
		
		ArrayList<Article> articles = new ArrayList<Article>();
		Document html = (Document) Jsoup.connect(url).get();

		word = word.replaceAll("\\s", ".{0,5}");
		String request = "a[href~=word_to_search], " +
						 "a:has(" +
						 	"img[title~=word_to_search],"  +
						 	   "[alt~=word_to_search],"       +
						 	"h1:contains(word_to_search)," +
						 	"h2:contains(word_to_search)," +
						 	"h3:contains(word_to_search)," +
						 	"h4:contains(word_to_search)," +
						 	"h5:contains(word_to_search)," +
						 	"h6:contains(word_to_search)," +
						 	"p:contains(word_to_search))";
		request = request.replace("word_to_search",word);
		//System.out.println("request:" + request + "\n");
		
		Elements links = ((org.jsoup.nodes.Element) html).select(request);
		
		
		for (org.jsoup.nodes.Element link : links)
		{ 
			 
			
			String sourceURL = url;
			String sourceLabel = "none";
			String txt = link.select("h1, h2, h3, h4, h5, h6").text();
			String img = link.select("img").attr("src").toString();
			String href = link.attr("href");
			
			Article article = new Article(sourceURL,sourceLabel,txt,img,href);
			articles.add(article);
			System.out.println("href= " + link.attr("abs:href"));
		}
		
		
		
		
		
		return articles;
	}
	
	*/
}
