#!/usr/bin/env python

from pymongo import MongoClient
from collections import OrderedDict
import sys
import urllib.request
import requests
import shutil
import gridfs
import mimetypes
from init_database import *
""" _id:objectId
    id_malware:string
    source_malware:string
    date_added_malware:date
    url_malware:string
    url_status_malware: bool
    threat_malware:string
    tags_malware:string
    url_haus_malware:string
    reporter_malware:string
    md5_malware:string
    sha256_malware:string
    sha1_malware:string
    ssdeep_malware:string
    is_exe_malware:bool
    imphash_malware:string
    rapport_vt_malware:objectId
    ip_malware:objectId"""

def file_from_url_to_gridfs(db, url, file_name):
    print("Put file from " + url + " to GriFS db.")
    try:
        fs = gridfs.GridFS(db)
        request = requests.get(url, stream=True, allow_redirects=True, timeout=30)
        final_name = requests.head(url, stream=True, allow_redirects=True, timeout=10).url
        print("FINAL_NAME:" + final_name)
        mime_type = mimetypes.guess_type(url)
        _id = fs.put(request.raw, contentType=mime_type, filename=file_name)
        print("Done.")
        return _id
    except:
        print("connection to link " + url + " failed.")


def add_malware_collection(id_malware, source_malware, date_added, url_malware, url_status, threat, tags, urlhaus_link, reporter, name_file):
    try:
        db = connect_database()
        query = {"id_malware":id_malware,
                "source_malware":source_malware,
                "date_added_malware":date_added,
                "url_malware":url_malware,
                "url_status_malware":url_status,
                "threat_malware": threat,
                "tags_malware": tags,
                "url_haus_malware":urlhaus_link,
                "reporter_malware":reporter,
                "name_file_malware":name_file,
        }
        db.malware_collection.insert(query)
        print("All good. File ID " + id_malware + " added to MongoDB.")
        return True
    except: 
        print("exc:", sys.exc_info())       

def add_vt_collection(scan_id_vt, total_scan_vt, positives_vt, resource_vt, response_vt, scan_date_vt, permalinks_vt, sha256_vt, md5_vt, sha1_vt, entire_report_vt, id_malware_vt):
    try:
        db = connect_database()
        query = {"scan_id_vt": scan_id_vt,
                 "total_scan_vt":total_scan_vt,
                 "positives_vt": positives_vt,
                 "response_vt":response_vt,
                 "resource_vt":resource_vt,
                 "scan_date_vt":scan_date_vt,
                 "permalinks_vt": permalinks_vt,
                 "sha256_vt": sha256_vt,
                 "sha1_vt": sha1_vt,
                 "md5_vt":md5_vt,
                 "entire_report_vt":entire_report_vt,
                 "id_malware_vt":id_malware_vt,
        }
        db.vt_collection.insert(query)
        print("All good.")
    except: 
        print("exc:", sys.exc_info())       

def add_label_collection(id_malware_label, output_avclassplusplus):

    try:
        db = connect_database()
        query = {"id_malware_label": id_malware_label,
                 "output_avclassplusplus": output_avclassplusplus,
        }
        db.label_collection.insert(query)
        print("All good.")
    except:
        print("exc:", sys.exc_info())
 
def add_ip_collection(id_malware_ip, country_name, ip, continent_code, continent_name, country_code, region_code, region_name, city, zip, latitude, longitude, full_report):

    try:
        db = connect_database()
        query = {"id_malware_ip": id_malware_ip,
                "country_name_ip": country_name,
                "address_ip":ip,
                "continent_code_ip":continent_code,
                "continent_name_ip":continent_name,
                "country_code_ip":country_code,
                "region_code_ip":region_code,
                "region_name_ip":region_name,
                "city_ip":city,
                "zip_ip":zip,
                "latitude_ip":latitude,
                "longitude_ip":longitude,
                "full_report_ip":full_report,
        }
        db.ip_collection.insert(query)
        print("All good.")
    except:
        print("exc:", sys.exc_info())     
