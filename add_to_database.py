#!/usr/bin/env python

from pymongo import MongoClient
from collections import OrderedDict
import sys
import urllib.request
import requests
import gridfs
import mimetypes
from init_database import *
""" _id:objectId
    id_malware:string
    source_malware:string
    date_added_malware:date
    url_malware:string
    url_status_malware: bool
    threat_malware:string
    tags_malware:string
    url_haus_malware:string
    reporter_malware:string
    md5_malware:string
    sha256_malware:string
    sha1_malware:string
    ssdeep_malware:string
    is_exe_malware:bool
    imphash_malware:string
    rapport_vt_malware:objectId
    ip_malware:objectId"""

def file_from_url_to_gridfs(db, url, file_name):
    print("Put file from " + url + " to GriFS db.")
    try:
        fs = gridfs.GridFS(db)
        request = requests.get(url, stream=True, timeout=10)
        mime_type = mimetypes.guess_type(url)
        _id = fs.put(request.raw, contentType=mime_type, filename=file_name)
        print("Done.")
        return _id
    except:
        print("connection to link " + url + " failed.")


def add_malware_collection(id_malware, source_malware, date_added, url_malware, url_status, threat, tags, urlhaus_link, reporter, name_file, id_file):

    try:
        db = connect_database()
        query = {"id_malware":id_malware,
                "source_malware":source_malware,
                "date_added_malware":date_added,
                "url_malware":url_malware,
                "url_status_malware":url_status,
                "threat_malware": threat,
                "tags_malware": tags,
                "urlhaus_link_malware":urlhaus_link,
                "reporter_malware":reporter,
                "name_file":name_file,
                "id_file":id_file
        }
        db.malware_collection.insert(query)
        print("All good. File ID " + id_malware + " added to MongoDB.")
        return True
    except: 
        print("exc:", sys.exc_info())       

def add_vt_collection(id_vt, total_scan_vt, positives_vt, resource_vt, response_vt, scan_date_vt, permalinks_vt, sha256_vt, md5_vt, id_labels_vt, id_malware_vt):

    try:
        db = connect_database()
        query = {"id_vt":id_vt,
                 "total_scan_vt":total_scan_vt,
                 "positives_vt": positives_vt,
                 "response_vt":response_vt,
                 "resource_vt":resource_vt,
                 "scan_date_vt":scan_date_vt,
                 "permalinks_vt": permalinks_vt,
                 "sha256_vt": sha256_vt,
                 "md5_vt":md5_vt,
                 "id_labels_vt":id_labels_vt,
                 "id_malware_vt":id_malware_vt,
        }
        db.vt_collection.insert(query)
        print("All good.")
    except: 
        print("exc:", sys.exc_info())       

def add_label_collection(name_antivirus_label, id_malware_label, id_vt_label):

    try:
        db = connect_database()
        query = {"name_antivirus_label":name_antivirus_label,
                 "id_malware_label": id_malware_label,
                 "id_vt_label": id_vt_label,
        }
        db.label_collection.insert(query)
        print("All good.")
    except:
        print("exc:", sys.exc_info())       
